# ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

> ë…¸ë“œ êµ¬ì„±, ë°ì´í„° íë¦„, MQTT í† í”½ êµ¬ì¡°

---

## ğŸ“Š ë…¸ë“œ êµ¬ì„±ë„

### SLAM ëª¨ë“œ (slam_exploration.launch.py)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SLAM ëª¨ë“œ                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ auto_drive  â”‚â”€â”€â–¶â”‚   /scan     â”‚â”€â”€â–¶â”‚ map_saver   â”‚           â”‚
â”‚  â”‚   _node     â”‚   â”‚  /odom      â”‚   â”‚   _node     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚        â”‚                                    â”‚                   â”‚
â”‚        â–¼                                    â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  /cmd_vel   â”‚                     â”‚ ì„œë²„ ì—…ë¡œë“œ  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ ultrasonic  â”‚   â”‚ led_ctrl    â”‚   â”‚ collision   â”‚           â”‚
â”‚  â”‚   _node     â”‚   â”‚   _node     â”‚   â”‚ _photo_node â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                          â”‚                                      â”‚
â”‚                          â”‚ /mqtt/mcu_sensors (Lux)              â”‚
â”‚                          â–¼                                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                    â”‚ mqtt_bridge â”‚ â—€â”€â”€ MCU (mcu/sensors)        â”‚
â”‚                    â”‚   _node     â”‚                              â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Nav2 ëª¨ë“œ (nav2_mode.launch.py)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Nav2 ëª¨ë“œ                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Nav2 bringup_launch.py                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚  AMCL  â”‚ â”‚ Planner â”‚ â”‚Controllerâ”‚ â”‚BT Navigatorâ”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        â–²                                                        â”‚
â”‚        â”‚ navigate_to_pose                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ nav2_goal   â”‚â—€â”€â”€â”‚ MQTT/PLC    â”‚   â”‚ camera      â”‚           â”‚
â”‚  â”‚   _node     â”‚   â”‚   ëª…ë ¹      â”‚   â”‚ _stream_nodeâ”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚ led_ctrl    â”‚â—€â”€â”€â”‚ mqtt_bridge â”‚ â—€â”€â”€ MCU (Lux ì„¼ì„œ)          â”‚
â”‚  â”‚   _node     â”‚   â”‚   _node     â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¡ MQTT í† í”½ êµ¬ì¡°

### ì „ì²´ í† í”½ ë§µ

```
MQTT Broker (192.168.0.3:1883)
â”‚
â”œâ”€â”€ ğŸ“¥ ì™¸ë¶€ â†’ ë¡œë´‡ (ìˆ˜ì‹ )
â”‚   â”‚
â”‚   â”œâ”€â”€ mcu/
â”‚   â”‚   â””â”€â”€ sensors               # MCU ì„¼ì„œ ë°ì´í„°
â”‚   â”‚
â”‚   â”œâ”€â”€ plc/
â”‚   â”‚   â”œâ”€â”€ location              # ìœ„ì¹˜ ì´ë¦„ ì´ë™
â”‚   â”‚   â””â”€â”€ goal                  # ì¢Œí‘œ ì´ë™
â”‚   â”‚
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â””â”€â”€ locations             # ìœ„ì¹˜ í”„ë¦¬ì…‹ ì—…ë°ì´íŠ¸
â”‚   â”‚
â”‚   â””â”€â”€ nav2/
â”‚       â””â”€â”€ initial_pose          # AMCL ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •
â”‚
â”œâ”€â”€ ğŸ“¤ ë¡œë´‡ â†’ ì™¸ë¶€ (ë°œí–‰)
â”‚   â”‚
â”‚   â”œâ”€â”€ robot/
â”‚   â”‚   â”œâ”€â”€ navigate_to_pose      # Goal ìš”ì²­ (ëª¨ë‹ˆí„°ë§ìš©)
â”‚   â”‚   â”œâ”€â”€ nav_status            # ì§„í–‰ ìƒíƒœ
â”‚   â”‚   â”œâ”€â”€ nav_result            # ì™„ë£Œ/ì‹¤íŒ¨ ê²°ê³¼
â”‚   â”‚   â””â”€â”€ arrived               # ëª©í‘œ ë„ì°©
â”‚   â”‚
â”‚   â”œâ”€â”€ slam_mode                 # SLAM/NAV2/IDLE
â”‚   â”‚
â”‚   â”œâ”€â”€ battery/
â”‚   â”‚   â””â”€â”€ status                # ë°°í„°ë¦¬ ì „ì•• (ì˜µì…˜)
â”‚   â”‚
â”‚   â”œâ”€â”€ collision/
â”‚   â”‚   â””â”€â”€ photo_ready           # ì¶©ëŒ ì‚¬ì§„ ì•Œë¦¼
â”‚   â”‚
â”‚   â”œâ”€â”€ qr_detected               # QR ì½”ë“œ ê°ì§€
â”‚   â”‚
â”‚   â””â”€â”€ ros/
â”‚       â””â”€â”€ map_cycle_complete    # ë§µ ì‚¬ì´í´ ì™„ë£Œ
â”‚
â””â”€â”€ ğŸ“Š AI ì„œë²„ ë°œí–‰
    â””â”€â”€ mqtt/pinky/
        â”œâ”€â”€ detection             # YOLO ê°ì§€ ê²°ê³¼
        â””â”€â”€ obstacle_type         # ì¥ì• ë¬¼ ìœ í˜•
```

---

## ğŸ“¬ MQTT ë©”ì‹œì§€ í˜•ì‹ (JSON)

### ë¡œë´‡ â†’ ì„œë²„ (ë°œí–‰)

```json
// robot/navigate_to_pose - Goal ìš”ì²­
{
  "type": "location",
  "value": "station1",
  "timestamp": 1733567890.123
}

// robot/nav_status - ì§„í–‰ ìƒíƒœ
{
  "status": "NAVIGATING",
  "message": "(1.50, 2.00)",
  "goal": {"x": 1.5, "y": 2.0, "yaw": 0.0}
}

// robot/nav_result - ì™„ë£Œ/ì‹¤íŒ¨ ê²°ê³¼
{
  "result": "SUCCEEDED",
  "message": "Goal reached!",
  "goal": {"x": 1.0, "y": 0.5, "yaw": 0},
  "timestamp": 1733567900.456
}

// robot/arrived - ëª©í‘œ ë„ì°©
{
  "arrived": true,
  "timestamp": 1733567901.789
}

// slam_mode - ë¡œë´‡ ëª¨ë“œ
{
  "mode": "SLAM",
  "timestamp": 1733567800.000
}

// ros/map_cycle_complete - ë§µ ì €ì¥ ì™„ë£Œ
{
  "cycle": 8,
  "pgm_path": "/home/pinky/saved_maps/map_07.pgm",
  "yaml_path": "/home/pinky/saved_maps/map_07.yaml",
  "timestamp": 1733568000.000
}

// collision/photo_ready - ì¶©ëŒ ì‚¬ì§„
{
  "filename": "collision_20251207_123456_0.25m.jpg",
  "url": "http://192.168.0.5:5001/photos/collision_20251207_123456_0.25m.jpg",
  "distance": 0.25,
  "timestamp": 1733568100.000
}

// qr_detected - QR ê°ì§€
{
  "data": "STATION_A",
  "timestamp": 1733568200.000
}

// battery/status - ë°°í„°ë¦¬
{
  "voltage": 11.8,
  "timestamp": 1733567860.000
}
```

### ì™¸ë¶€ â†’ ë¡œë´‡ (ìˆ˜ì‹ )

```json
// mcu/sensors - MCU ì„¼ì„œ
{
  "Lux": 150.5,
  "Temperature": 25.3,
  "Humidity": 45.0
}

// plc/location - ìœ„ì¹˜ ì´ë¦„
"station1"

// plc/goal - ì¢Œí‘œ Goal
{
  "x": 2.0,
  "y": 1.5,
  "yaw": 1.57
}

// server/locations - ìœ„ì¹˜ í”„ë¦¬ì…‹
{
  "station1": {"x": 1.0, "y": 0.5, "yaw": 0},
  "station2": {"x": 2.0, "y": 1.0, "yaw": 1.57},
  "charging": {"x": -0.5, "y": 0, "yaw": 3.14}
}

// nav2/initial_pose - ì´ˆê¸° ìœ„ì¹˜
{
  "x": 0.0,
  "y": 0.0,
  "yaw": 0.0
}
```

### AI ì„œë²„ ë°œí–‰

```json
// mqtt/pinky/detection - YOLO ê°ì§€
{
  "objects": [
    {"class": "person", "confidence": 0.92, "bbox": [100, 50, 200, 300]},
    {"class": "box", "confidence": 0.87, "bbox": [250, 100, 350, 200]}
  ],
  "timestamp": 1733568300.000
}

// mqtt/pinky/obstacle_type - ì¥ì• ë¬¼ ìœ í˜•
{
  "type": "person",
  "action": "wait",
  "timestamp": 1733568301.000
}
```

---

## ğŸ“ ROS2 â†” MQTT ë§¤í•‘ í…Œì´ë¸”

| ROS2 Topic | MQTT Topic | ë°©í–¥ |
|------------|------------|------|
| `/robot_mode` | `slam_mode` | ROS2 â†’ MQTT |
| `/nav2/status` | `robot/nav_status` | ROS2 â†’ MQTT |
| `/nav2/status` (ê²°ê³¼) | `robot/nav_result` | ROS2 â†’ MQTT |
| `/nav2/arrived` | `robot/arrived` | ROS2 â†’ MQTT |
| `/collision/photo_ready` | `collision/photo_ready` | ROS2 â†’ MQTT |
| `/qr_detected` | `qr_detected` | ROS2 â†’ MQTT |
| `/battery/voltage` | `battery/status` | ROS2 â†’ MQTT |
| `/map_saver/cycle_complete` | `ros/map_cycle_complete` | ROS2 â†’ MQTT |
| `mcu/sensors` | `/mqtt/mcu_sensors` | MQTT â†’ ROS2 |
| `plc/location` | `/mqtt/plc_location` | MQTT â†’ ROS2 |
| `plc/goal` | `/mqtt/plc_goal` | MQTT â†’ ROS2 |

---

## ğŸ”„ ë°ì´í„° íë¦„

### Nav2 Goal íë¦„

```
PLC/ì„œë²„                    ë¡œë´‡                         Nav2
    â”‚                        â”‚                           â”‚
    â”‚  plc/location          â”‚                           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ mqtt_bridge_node          â”‚
    â”‚                        â”‚       â”‚                   â”‚
    â”‚                        â”‚       â–¼                   â”‚
    â”‚  robot/navigate_to_poseâ”‚ nav2_goal_node            â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚                   â”‚
    â”‚                        â”‚       â”‚ NavigateToPose    â”‚
    â”‚                        â”‚       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                        â”‚       â”‚                   â”‚
    â”‚  robot/nav_status      â”‚       â”‚â—€â”€â”€ feedback â”€â”€â”€â”€â”€â”€â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚                   â”‚
    â”‚                        â”‚       â”‚                   â”‚
    â”‚  robot/nav_result      â”‚       â”‚â—€â”€â”€ result â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚                   â”‚
    â”‚                        â”‚       â”‚                   â”‚
```

### MCU ì„¼ì„œ â†’ LED ì œì–´ íë¦„

```
MCU (ESP32)              MQTT Broker              ROS2
    â”‚                        â”‚                      â”‚
    â”‚  {"Lux": 150.5}        â”‚                      â”‚
    â”œâ”€â”€â”€â”€ mcu/sensors â”€â”€â”€â”€â”€â”€â–¶â”‚                      â”‚
    â”‚                        â”‚                      â”‚
    â”‚                        â”‚  /mqtt/mcu_sensors   â”‚
    â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ mqtt_bridge_node
    â”‚                        â”‚                      â”‚       â”‚
    â”‚                        â”‚                      â”‚       â–¼
    â”‚                        â”‚                      â”‚ led_controller_node
    â”‚                        â”‚                      â”‚   (Lux ê¸°ë°˜ LED ì œì–´)
```
